{% extends 'quiz/base.html' %}

{% block title %}{{ question_number }}/{{ total_questions }} - {{ user_session.quiz.title }}{% endblock %}

{% block content %}
<div class="p-4">
    <!-- ÏßÑÌñâÎ•† ÌëúÏãú -->
    <div class="mb-6 animate-fade-in">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>{{ user_session.nickname }}</span>
            <span>{{ question_number }} / {{ total_questions }}</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full progress-bar" 
                 id="progress-bar"></div>
        </div>
        <div class="text-center mt-2">
            <span class="text-xs text-gray-500">{{ progress_percentage|floatformat:0 }}% ÏôÑÎ£å</span>
        </div>
    </div>
    
    <!-- ÌòÑÏû¨ Ï†êÏàò -->
    <div class="bg-white rounded-lg p-4 mb-6 shadow-sm animate-fade-in">
        <div class="flex items-center justify-center space-x-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-500">{{ user_session.score }}</div>
                <div class="text-xs text-gray-600">ÌòÑÏû¨ Ï†êÏàò</div>
            </div>
            <div class="text-gray-300">|</div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-500">{{ total_questions }}</div>
                <div class="text-xs text-gray-600">Ï¥ù Î¨∏Ï†ú</div>
            </div>
        </div>
    </div>
    
    <!-- ÏßàÎ¨∏ Ïπ¥Îìú -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 animate-bounce-in">
        <div class="text-center mb-4">
            <span class="text-4xl">ü§î</span>
        </div>
        <h2 class="text-lg font-semibold text-gray-800 mb-4 text-center leading-relaxed">
            {{ question.text }}
        </h2>
        <div class="text-center">
            <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                Î¨∏Ï†ú {{ question_number }}
            </span>
        </div>
    </div>
    
    <!-- ÏÑ†ÌÉùÏßÄ -->
    <div class="space-y-3 mb-6">
        {% for choice in choices %}
        <button type="button" 
                class="choice-option w-full bg-white border-2 border-gray-200 rounded-lg p-4 text-left hover:border-primary-500 hover:bg-primary-50 transition-all touch-feedback animate-fade-in"
                data-choice-id="{{ choice.id }}"
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 border-2 border-gray-300 rounded-full flex items-center justify-center choice-indicator">
                    <span class="text-sm font-medium text-gray-500">{{ forloop.counter }}</span>
                </div>
                <div class="flex-1">
                    <p class="text-gray-800 font-medium">{{ choice.text }}</p>
                </div>
            </div>
        </button>
        {% endfor %}
    </div>
    
    <!-- ÎãµÎ≥Ä Í≤∞Í≥º Î™®Îã¨ -->
    <div id="answer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm w-full animate-bounce-in">
            <div class="text-center">
                <div id="result-emoji" class="text-6xl mb-4"></div>
                <h3 id="result-title" class="text-xl font-bold mb-2"></h3>
                <p id="result-message" class="text-gray-600 mb-4"></p>
                <div id="correct-answer" class="bg-gray-100 rounded-lg p-3 mb-4 hidden">
                    <p class="text-sm text-gray-700">
                        <strong>Ï†ïÎãµ:</strong> <span id="correct-answer-text"></span>
                    </p>
                </div>
                <button id="next-button" 
                        class="w-full bg-primary-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-primary-600 transition-colors touch-feedback">
                    Îã§Ïùå Î¨∏Ï†ú
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block bottom_actions %}
<div class="text-center text-gray-500 text-sm">
    <p>ÏÑ†ÌÉùÏßÄÎ•º ÎàåÎü¨ ÎãµÎ≥ÄÌï¥Ï£ºÏÑ∏Ïöî</p>
    <div class="mt-2 flex justify-center space-x-2">
        <span class="w-2 h-2 bg-gray-300 rounded-full animate-pulse"></span>
        <span class="w-2 h-2 bg-gray-300 rounded-full animate-pulse" style="animation-delay: 0.2s"></span>
        <span class="w-2 h-2 bg-gray-300 rounded-full animate-pulse" style="animation-delay: 0.4s"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const choiceButtons = document.querySelectorAll('.choice-option');
    const answerModal = document.getElementById('answer-modal');
    const resultEmoji = document.getElementById('result-emoji');
    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');
    const correctAnswerDiv = document.getElementById('correct-answer');
    const correctAnswerText = document.getElementById('correct-answer-text');
    const nextButton = document.getElementById('next-button');
    const progressBar = document.getElementById('progress-bar');
    
    // ÏßÑÌñâÎ•† ÏÑ§Ï†ï
    progressBar.style.width = '{{ progress_percentage }}%';
    
    let selectedChoice = null;
    let isSubmitting = false;
    
    // ÏÑ†ÌÉùÏßÄ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    choiceButtons.forEach(button => {
        button.addEventListener('click', function() {
            if (isSubmitting) return;
            
            // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ï†úÍ±∞
            choiceButtons.forEach(btn => {
                btn.classList.remove('border-primary-500', 'bg-primary-50');
                btn.classList.add('border-gray-200');
                const indicator = btn.querySelector('.choice-indicator');
                indicator.classList.remove('bg-primary-500', 'text-white');
                indicator.classList.add('border-gray-300');
                indicator.querySelector('span').classList.remove('text-white');
                indicator.querySelector('span').classList.add('text-gray-500');
            });
            
            // ÌòÑÏû¨ ÏÑ†ÌÉù ÌëúÏãú
            this.classList.remove('border-gray-200');
            this.classList.add('border-primary-500', 'bg-primary-50');
            const indicator = this.querySelector('.choice-indicator');
            indicator.classList.remove('border-gray-300');
            indicator.classList.add('bg-primary-500', 'text-white');
            indicator.querySelector('span').classList.remove('text-gray-500');
            indicator.querySelector('span').classList.add('text-white');
            
            selectedChoice = this.dataset.choiceId;
            
            // ÌñÖÌã± ÌîºÎìúÎ∞±
            hapticFeedback();
            
            // ÎãµÎ≥Ä Ï†úÏ∂ú
            submitAnswer();
        });
    });
    
    // ÎãµÎ≥Ä Ï†úÏ∂ú Ìï®Ïàò
    function submitAnswer() {
        if (!selectedChoice || isSubmitting) return;
        
        isSubmitting = true;
        showLoading();
        
        // Î™®Îì† ÏÑ†ÌÉùÏßÄ ÎπÑÌôúÏÑ±Ìôî
        choiceButtons.forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-60');
        });
        
        fetch(`/submit/{{ user_session.session_id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                choice_id: selectedChoice
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showResult(data);
            } else {
                alert(data.error || 'Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                isSubmitting = false;
                // ÏÑ†ÌÉùÏßÄ Îã§Ïãú ÌôúÏÑ±Ìôî
                choiceButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-60');
                });
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            isSubmitting = false;
            // ÏÑ†ÌÉùÏßÄ Îã§Ïãú ÌôúÏÑ±Ìôî
            choiceButtons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-60');
            });
        });
    }
    
    // Í≤∞Í≥º ÌëúÏãú Ìï®Ïàò
    function showResult(data) {
        if (data.is_correct) {
            resultEmoji.textContent = 'üéâ';
            resultTitle.textContent = 'Ï†ïÎãµÏûÖÎãàÎã§!';
            resultTitle.className = 'text-xl font-bold mb-2 text-green-600';
            resultMessage.textContent = 'ÌõåÎ•≠Ìï¥Ïöî! Îã§Ïùå Î¨∏Ï†úÎ°ú ÎÑòÏñ¥Í∞ÄÏÑ∏Ïöî.';
            correctAnswerDiv.classList.add('hidden');
        } else {
            resultEmoji.textContent = 'üòÖ';
            resultTitle.textContent = 'ÌãÄÎ†∏Ïñ¥Ïöî';
            resultTitle.className = 'text-xl font-bold mb-2 text-red-600';
            resultMessage.textContent = 'ÏïÑÏâΩÏßÄÎßå Îã§Ïùå Î¨∏Ï†úÏóêÏÑú ÌôîÏù¥ÌåÖ!';
            correctAnswerText.textContent = data.correct_answer;
            correctAnswerDiv.classList.remove('hidden');
        }
        
        // Îã§Ïùå Î≤ÑÌäº ÏÑ§Ï†ï
        nextButton.onclick = function() {
            window.location.href = data.next_url;
        };
        
        // Î™®Îã¨ ÌëúÏãú
        answerModal.classList.remove('hidden');
        
        // ÌñÖÌã± ÌîºÎìúÎ∞±
        if (data.is_correct) {
            // Ï†ïÎãµÏùº Îïå Îçî Í∞ïÌïú ÏßÑÎèô
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        } else {
            hapticFeedback();
        }
    }
    
    // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ (1,2,3,4 ÌÇ§Î°ú ÏÑ†ÌÉù)
    document.addEventListener('keydown', function(e) {
        if (isSubmitting) return;
        
        const key = parseInt(e.key);
        if (key >= 1 && key <= choiceButtons.length) {
            choiceButtons[key - 1].click();
        }
    });
    
    // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞ Î∞©ÏßÄ
    answerModal.addEventListener('click', function(e) {
        e.stopPropagation();
    });
});
</script>
{% endblock %} 